name: Build Base Maps4FS API Image

on:
  workflow_dispatch:
    inputs:
      tag_version:
        description: 'Tag version for the base image'
        required: true
        default: '0.0.1'
        type: string

jobs:
  build-base:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Login to DockerHub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build and push base Maps4FS API image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          iwatkot/maps4fsapibase:latest
          iwatkot/maps4fsapibase:${{ inputs.tag_version }}
        file: ./Dockerfile.base

    - name: Test base image
      run: |
        docker run --rm iwatkot/maps4fsapibase:${{ inputs.tag_version }} python -c "import cv2, rasterio, geopy, trimesh, pydantic, owslib, tqdm, scipy, manifold3d, open3d; print('All dependencies imported successfully!')"

    - name: Summary
      run: |
        echo "## ðŸš€ Base Maps4FS API Image Build Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Image:** \`iwatkot/maps4fsapibase:${{ inputs.tag_version }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Base Image:** \`iwatkot/blender:latest\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Included Dependencies:" >> $GITHUB_STEP_SUMMARY
        echo "- opencv-python" >> $GITHUB_STEP_SUMMARY
        echo "- rasterio" >> $GITHUB_STEP_SUMMARY
        echo "- geopy" >> $GITHUB_STEP_SUMMARY
        echo "- trimesh<=4.8.2" >> $GITHUB_STEP_SUMMARY
        echo "- pydantic" >> $GITHUB_STEP_SUMMARY
        echo "- owslib" >> $GITHUB_STEP_SUMMARY
        echo "- tqdm" >> $GITHUB_STEP_SUMMARY
        echo "- scipy" >> $GITHUB_STEP_SUMMARY
        echo "- manifold3d" >> $GITHUB_STEP_SUMMARY
        echo "- fast-simplification" >> $GITHUB_STEP_SUMMARY
        echo "- open3d" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸš€ Next Steps:" >> $GITHUB_STEP_SUMMARY
        echo "- Main maps4fsapi builds will now use this base image" >> $GITHUB_STEP_SUMMARY
        echo "- Docker builds will be significantly faster!" >> $GITHUB_STEP_SUMMARY
        echo "- Only application code and lightweight dependencies will be installed on each build" >> $GITHUB_STEP_SUMMARY
